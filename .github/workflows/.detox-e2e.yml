name: Detox E2E Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detox-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
    
    - name: Set up Node
      uses: actions/setup-node@v3
      with:
        node-version: '18.15.0'
      
    - name: Install Global Dependencies
      run: |
        npm install -g yarn
        sudo gem install cocoapods
          
    - name: Install Project Dependencies
      run: |
        yarn remove mobile-protect
        yarn install && yarn run link
        cp env.test.json env.json
        cd ios && pod install && cd ..
        
    - name: Install Homebrew Dependencies
      run: |
        brew install jq
        brew tap wix/brew
        brew install wix/brew/applesimutils
    
    - name: Start Metro Bundler
      run: |
        npx react-native start &
        
    - name: Run Detox build
      run: |
        yarn detox build --configuration ios.debug
    
    - name: Run Detox tests
      run: |
        yarn detox test --configuration ios.debug --cleanup --headless --record-logs all
        
    - name: Stop Metro Bundler
      run: pkill -f "node.*react-native"
